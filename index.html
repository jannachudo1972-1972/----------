<html lang="ru"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ó–∞–¥–∞—á–∏ JSON ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ñ–∏–ª—å—Ç—Ä—ã, –ø–µ—á–∞—Ç—å</title>
  <style>
    :root { 
      --gap: 8px; 
      --b:#e1e5e9; 
      --bg:#f8fafc; 
      --txt:#1e293b; 
      --accent:#3b82f6; 
      --success:#10b981;
      --danger:#ef4444;
      --basic:#6ee7b7; --medium:#facc15; --hard:#ef4444;
    }
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif; 
      margin: 0; 
      color: var(--txt); 
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      line-height: 1.5;
      padding-top: 200px;
    }
    .fixed-controls { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      z-index: 1000;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      backdrop-filter: blur(20px);
    }
    .row { display:flex; gap: var(--gap); flex-wrap: wrap; align-items: end; }
    .card { 
      border:1px solid var(--b); 
      border-radius: 12px; 
      padding: 12px; 
      background: white; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .controls { background: var(--bg); }
    .count-badge { 
      background: var(--accent); color: white; 
      padding: 4px 10px; border-radius: 20px; 
      font-weight: 600; font-size: 13px;
      box-shadow: 0 2px 8px rgba(59,130,246,0.3);
    }
    label { font-size: 12px; color:#64748b; display:block; margin-bottom: 4px; font-weight: 500; }
    input[type="text"], input[type="file"], select { 
      padding: 8px 10px; 
      border:1px solid var(--b); 
      border-radius: 6px; 
      font-size: 13px;
      transition: border-color 0.2s;
      min-width: 140px;
    }
    input:focus, select:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    select.dropdown { 
      background: white url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e") no-repeat right 10px center;
      background-size: 14px;
      appearance: none;
      cursor: pointer;
    }
    button { 
      padding: 8px 12px; 
      border:1px solid var(--b); 
      border-radius: 6px; 
      background: white; 
      cursor: pointer; 
      font-weight: 500;
      font-size: 13px;
      transition: all 0.2s;
    }
    button:hover { background: #f8fafc; transform: translateY(-1px); }
    button.primary { background:var(--accent); color:white; border-color:var(--accent); }
    button.primary:hover { background: #2563eb; }
    button.danger { background:var(--danger); color:white; border-color:var(--danger); }
    button.success { background: var(--success); color: white; border-color: var(--success); }
    .difficulty-btn { 
      width: 60px; height: 40px; 
      border-radius: 8px; 
      border: 2px solid var(--b);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 10px; font-weight: bold; color: white;
      margin: 2px;
      cursor: pointer; transition: all 0.2s;
    }
    .difficulty-btn.all { background: var(--accent); border-color: var(--accent); width: 64px; }
    .difficulty-btn.basic { background: var(--basic); border-color: #059669; }
    .difficulty-btn.medium { background: var(--medium); border-color: #d97706; }
    .difficulty-btn.hard { background: var(--hard); border-color: #dc2626; }
    .difficulty-btn.active { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .difficulty-row { display: flex; flex-wrap: wrap; gap: 4px; }
    .sort-btn { padding: 6px 10px; font-size: 11px; min-width: 0; }
    .toggle-answers { background: var(--success); color: white; }
    .toggle-answers.active { background: var(--danger); }
    .muted { color:#94a3b8; font-size: 12px; }
    .grid { display:grid; gap: var(--gap); padding: 20px var(--gap); padding-bottom: 100px; }
    .task { 
      border:1px solid var(--b); 
      border-radius: 16px; 
      overflow:hidden; 
      background: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transition: box-shadow 0.2s;
      margin-bottom: var(--gap);
    }
    .task:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
    .task-head { 
      padding: 16px 20px; 
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); 
      display:flex; 
      justify-content: space-between; 
      gap:12px; 
      align-items: center; 
    }
    .title { font-weight: 700; font-size: 18px; color: var(--txt); }
    .badges { display:flex; gap: 8px; flex-wrap: wrap; font-size: 12px; }
    .badge { 
      border:1px solid #cbd5e1; 
      border-radius: 20px; 
      padding: 4px 10px; 
      background:white; 
      font-size: 11px;
      font-weight: 500;
    }
    .badge.section { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; }
    .badge.difficulty { display: flex; align-items: center; gap: 4px; }
    .task-body { padding: 20px; display:grid; gap: 16px; }
    .zone { 
      border:2px dashed #e2e8f0; 
      border-radius: 12px; 
      padding: 16px; 
      background: #fafbfc; 
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .zone.task-zone { min-height: 80px; }
    .zone.answer-zone { 
      min-height: 20px; 
      
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }
    .zone:hover { border-color: var(--accent); background: #f0f9ff; }
    .zone:focus { outline: 2px solid var(--accent); }
    .zone h4 { margin: 0 0 12px 0; font-size: 14px; color:#64748b; font-weight: 600; text-align: center; }
    .zone .hint { font-size: 12px; color:#94a3b8; margin-top: 8px; }
    .zone img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .zone.answer-zone img { 
  max-width: 100%; 
  max-height: 300px; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—ã—Å–æ—Ç–µ */
  width: auto; 
  height: auto; 
  object-fit: contain; /* –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
  transform: none; /* –£–±–∏—Ä–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ */
}    .zone.empty::after { 
      content: "Ctrl+V –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏"; 
      color:#94a3b8; 
      font-size: 13px; 
      text-align: center;
    }
    .actions { display:flex; gap: 8px; flex-wrap: wrap; }
    .split { 
  display:grid; 
  grid-template-columns: 2fr 1fr; /* 1.3 : 1 ‚âà 30% —à–∏—Ä–µ */
  gap: var(--gap); 
}
    .meta-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 0.7fr 1.3fr;)); gap: 8px; margin-top: 12px; }
    .link { 
      color: var(--accent); 
      text-decoration: none; 
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 6px;
      background: rgba(59,130,246,0.1);
      transition: all 0.2s;
    }
    .link:hover { background: rgba(59,130,246,0.2); }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —á–µ—Ä—Ç–µ–∂–∞ –∏ —Ä–µ—à–µ–Ω–∏—è */
    .image-buttons { 
      display: flex; 
      gap: 8px; 
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .image-btn { 
      padding: 6px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .image-btn:hover { 
      background: #f1f5f9;
      transform: translateY(-1px);
    }
    .image-btn.has-image { 
      background: #dbeafe;
      border-color: #3b82f6;
      color: #1e40af;
    }
    .image-btn.has-image:hover { 
      background: #bfdbfe;
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }
    .modal-content {
      max-width: 90%;
      max-height: 90%;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    .modal-img {
      max-width: 100%;
      max-height: 80vh;
      width: auto;
      height: auto;
      display: block;
    }
    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-close:hover {
      background: rgba(0,0,0,0.9);
    }
    
    @media (max-width: 900px) { 
      .split { grid-template-columns: 2fr 1fr; } 
      body { padding-top: 220px; }
      .meta-row { grid-template-columns: 2fr 1fr; }
    }
    
@media print {
      body { margin: 0; background: white !important; padding-top: 0 !important; }
      .no-print, .fixed-controls, .meta-row, .actions, .controls { display:none !important; }
      #printRoot { display:block !important; }
      .task { break-inside: avoid; box-shadow: none; margin-bottom: 40px; page-break-inside: avoid; }
      .title { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: black !important; }
      .zone { border: none; padding: 0; background: transparent !important; margin-bottom: 25px; }
      .zone img { box-shadow: none; max-width: 100%; max-height: 600px; width: auto; height: auto; display: block; }
        .zone.answer-zone img { 
    border: 2px solid #f59e0b; 
    margin-top: 20px;
    max-width: 50% !important;
    max-height: 200px !important;
    transform: scale(0.5) !important;
    transform-origin: left top !important;
    text-align: left !important;}
    }
    #printRoot { display:none; }
  </style>
<style type="text/css" id="operaUserStyle"></style></head>
<body>

  <div class="fixed-controls no-print">
    <div class="card controls">
      <div class="row">
        <div>
          <label>üìÅ –ò–º–ø–æ—Ä—Ç</label>
          <input id="fileInput" type="file" accept="application/json,.json">
        </div>
        <div>
          <label>üíæ –≠–∫—Å–ø–æ—Ä—Ç</label>
          <button id="btnExport" class="primary">tasks.json</button>
        </div>
        <div>
          <label>‚ûï –†–∞–∑–¥–µ–ª</label>
          <button id="btnAddSection" class="success">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª</button>
        </div>
        <div>
          <label>‚ûï –ù–æ–≤–∞—è</label>
          <button id="btnAdd" class="success">–ó–∞–¥–∞—á–∞</button>
        </div>

<div class="print-options">
  <button id="btnToggleAnswers" class="toggle-answers">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
  <button id="btnToggleDrawingsSolutions" class="primary">üìê –ü–æ–∫–∞–∑–∞—Ç—å —á–µ—Ä—Ç–µ–∂–∏/—Ä–µ—à–µ–Ω–∏—è</button>
  <button id="btnPrintNoAnswer" class="primary" title="–ë–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤">üñ®Ô∏è –ë–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤</button>
  <button id="btnPrintWithAnswer" class="primary" title="–° –æ—Ç–≤–µ—Ç–∞–º–∏">üñ®Ô∏è –° –æ—Ç–≤–µ—Ç–∞–º–∏</button>
</div>

        <div style="flex:1">
          <label>üîç –ü–æ–∏—Å–∫</label>
          <input id="q" type="text" placeholder="–Ω–æ–º–µ—Ä-—Ç–µ–º–∞">
        </div>
      </div>

      <hr style="border:0;border-top:1px solid var(--b); margin: 12px 0;">

      <div class="row" id="filterRow">
        <div>
          <label>üìÇ –†–∞–∑–¥–µ–ª</label>
          <select id="fSection" class="dropdown"><option value="">–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã</option><option value="–ê–ù–ê–õ–ò–¢–ò–ö–ê –ü–†–û–ß–ï–ï">–ê–ù–ê–õ–ò–¢–ò–ö–ê –ü–†–û–ß–ï–ï</option></select>
        </div>
        
        <div>
          <label>üìä –°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
          <div class="difficulty-row">
            <button class="difficulty-btn all active" data-difficulty="">–í–°–ï</button>
            <button class="difficulty-btn basic" data-difficulty="basic">üü¢ –õ—ë–≥–∫–∞—è</button>
            <button class="difficulty-btn medium" data-difficulty="medium">üü° –°—Ä–µ–¥–Ω—è—è</button>
            <button class="difficulty-btn hard" data-difficulty="hard">üî¥ –°–ª–æ–∂–Ω–∞—è</button>
          </div>
        </div>
        
        <div>
          <label>‚úÖ –†–µ—à–µ–Ω–Ω—ã–µ </label>
          <select id="fSolved" class="dropdown">
            <option value="">–í—Å–µ</option>
            <option value="true">–†–µ—à—ë–Ω–Ω—ã–µ</option>
            <option value="false">–ù–µ —Ä–µ—à—ë–Ω–Ω—ã–µ</option>
          </select>
        </div>
        
        <div>
          <label>‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</label>
          <select id="fFav" class="dropdown">
            <option value="">–í—Å–µ</option>
            <option value="true">–¢–æ–ª—å–∫–æ –∏–∑–±.</option>
            <option value="false">–ù–µ –∏–∑–±.</option>
          </select>
        </div>
        
        <div>
          <label>üî§ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
          <button id="sortTitle" class="sort-btn primary">‚Üë –Ω–∞–∑–≤–∞–Ω–∏–µ</button>
        </div>
        
        <div id="countContainer"><div class="count-badge">üìä 1</div></div>
      </div>
    </div>
  </div>

  <div id="app" class="grid no-print">
      <div class="task" data-id="1768892475986">
        <div class="task-head">
          <div>
            <div class="title">18.2</div>
            <div class="badges">
              <span class="badge section">üìÇ –ê–ù–ê–õ–ò–¢–ò–ö–ê –ü–†–û–ß–ï–ï</span>
              <span class="badge difficulty">üìä 
                <span style="color: #059669; font-weight: bold;">
                  –õ—ë–≥–∫–∞—è
                </span>
              </span>
              <span class="badge">‚ùå –Ω–µ —Ä–µ—à–µ–Ω–æ</span>
              <span class="badge">‚òÜ</span>
            </div>
          </div>
          <div class="actions">
            <button data-act="toggleSolved">–í —Ä–µ—à—ë–Ω–Ω—ã–µ ‚úÖ</button>
            <button data-act="toggleFav">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚≠ê</button>
            <button data-act="edit" class="primary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button data-act="clearImages">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button data-act="delete" class="danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
        
        <div class="task-body">
          <div class="split">
            <div class="zone task-zone empty" data-zone="taskImage" tabindex="0">
              <h4>üìã –£—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏</h4>
              
              <div class="hint">Ctrl+V –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏</div>
            </div>
            
            <div class="zone answer-zone empty" data-zone="answerImage" tabindex="0">
              <h4>üí° –û—Ç–≤–µ—Ç</h4>
              
              <div class="hint">–∫–ª–∏–∫–Ω–∏ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>
              <div class="hint">Ctrl+V –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏</div>
            </div>
          </div>
          
          <!-- –ù–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —á–µ—Ä—Ç–µ–∂–∞ –∏ —Ä–µ—à–µ–Ω–∏—è -->
          <div class="image-buttons">
            <button class="image-btn" data-act="showDrawing">
              üìê –ß–µ—Ä—Ç–µ–∂
            </button>
            <button class="image-btn" data-act="showSolution">
              üìù –†–µ—à–µ–Ω–∏–µ
            </button>
          </div>
          
        </div>
      </div>
    </div>
  <div id="printRoot"></div>

<script>
(() => {


let availableSections = new Set(["–ê–ù–ê–õ–ò–¢–ò–ö–ê –ü–†–û–ß–ï–ï"]); // –ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã

  let tasks = [];
  let editingTaskId = null;
  let sortByTitle = false;
  let allAnswersVisible = false;

// –í JavaScript –¥–æ–±–∞–≤—å—Ç–µ
let allDrawingsSolutionsVisible = false;
const btnToggleDrawingsSolutions = document.getElementById('btnToggleDrawingsSolutions');

btnToggleDrawingsSolutions.addEventListener('click', () => {
  allDrawingsSolutionsVisible = !allDrawingsSolutionsVisible;
  btnToggleDrawingsSolutions.textContent = allDrawingsSolutionsVisible 
    ? 'üìê –°–∫—Ä—ã—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏' 
    : 'üìê –ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏';
  render();
});

  const app = document.getElementById('app');
  const printRoot = document.getElementById('printRoot');
  const countContainer = document.getElementById('countContainer');
  const sortTitleBtn = document.getElementById('sortTitle');
  const btnToggleAnswers = document.getElementById('btnToggleAnswers');
  const btnAddSection = document.getElementById('btnAddSection');
  
  const fileInput = document.getElementById('fileInput');
  const btnExport = document.getElementById('btnExport');
  const btnAdd = document.getElementById('btnAdd');
  const btnPrintNoAnswer = document.getElementById('btnPrintNoAnswer');
  const btnPrintWithAnswer = document.getElementById('btnPrintWithAnswer');
  const q = document.getElementById('q');
  const fSection = document.getElementById('fSection');
  const fSolved = document.getElementById('fSolved');
  const fFav = document.getElementById('fFav');
  const difficultyBtns = document.querySelectorAll('.difficulty-btn');

  const uid = () => Date.now() + Math.floor(Math.random() * 1000);


  function normalizeTask(t) {
    return {
      id: t.id || uid(),
      title: t.title || "",
      solutionLink: t.solutionLink || "",
      videoLink: t.videoLink || "",
      taskImage: t.taskImage || "",
      answerImage: t.answerImage || "",
      drawingImage: t.drawingImage || "",  // –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —á–µ—Ä—Ç–µ–∂–∞
      solutionImage: t.solutionImage || "", // –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è
      isAnswerVisible: t.isAnswerVisible || false,
      isSolved: t.isSolved || false,
      isFavorite: t.isFavorite || false,
      difficulty: t.difficulty || "basic",
      section: t.section || "",
      sectionName: t.sectionName || "",
      isSectionHeader: t.isSectionHeader || false  // —Ñ–ª–∞–≥ –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤
    };
  }

  function resetFilters() {
    q.value = '';
    fSection.value = '';
    fSolved.value = '';
    fFav.value = '';
    difficultyBtns.forEach(b => b.classList.remove('active'));
    document.querySelector('.difficulty-btn.all').classList.add('active');
    sortByTitle = false;
    sortTitleBtn.textContent = '‚Üë –Ω–∞–∑–≤–∞–Ω–∏–µ';
  }

  function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = String(s);
    return div.innerHTML;
  }

  function toDataUrlFromFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function getAllSections() {
  // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–∞–∑–¥–µ–ª—ã –∏–∑ –∑–∞–¥–∞—á –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã
  const sections = new Set([...availableSections]);
  tasks.forEach(task => {
    if (task.sectionName && task.sectionName.trim() && !task.isSectionHeader) {
      sections.add(task.sectionName.trim());
    }
  });
  return Array.from(sections).sort();
}

function updateSectionDropdown() {
  const sections = getAllSections();
  const currentValue = fSection.value;
  fSection.innerHTML = `<option value="">–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã</option>` + 
    sections.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
  if (sections.includes(currentValue)) {
    fSection.value = currentValue;
  }
}

  function matchesFilters(task) {
    // –†–∞–∑–¥–µ–ª—ã –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
    if (task.isSectionHeader) return true;
    
    const search = q.value.trim().toLowerCase();
    if (search && !(task.title + ' ' + task.sectionName).toLowerCase().includes(search)) return false;
    
    if (fSection.value && task.sectionName !== fSection.value) return false;
    const activeDifficulty = document.querySelector('.difficulty-btn.active')?.dataset.difficulty;
    if (activeDifficulty && activeDifficulty !== '' && task.difficulty !== activeDifficulty) return false;
    if (fSolved.value !== '' && String(!!task.isSolved) !== fSolved.value) return false;
    if (fFav.value !== '' && String(!!task.isFavorite) !== fFav.value) return false;
    
    return true;
  }

  function getFilteredAndSortedTasks() {
    let filtered = tasks.filter(matchesFilters);
    
    if (fSection.value || sortByTitle) {
      filtered.sort((a, b) => {
        if (a.isSectionHeader !== b.isSectionHeader) {
          return a.isSectionHeader ? -1 : 1; // —Ä–∞–∑–¥–µ–ª—ã —Å–≤–µ—Ä—Ö—É
        }
        const titleA = (a.title || '').toString().toLowerCase();
        const titleB = (b.title || '').toString().toLowerCase();
        return titleA.localeCompare(titleB);
      });
    }
    
    return filtered;
  }

  function showModal(imageSrc, title) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-content">
        <button class="modal-close">√ó</button>
        <img src="${imageSrc}" alt="${title}" class="modal-img">
      </div>
    `;
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal || e.target.classList.contains('modal-close')) {
        document.body.removeChild(modal);
      }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
    document.addEventListener('keydown', function closeModal(e) {
      if (e.key === 'Escape') {
        document.body.removeChild(modal);
        document.removeEventListener('keydown', closeModal);
      }
    });
  }

  function render() {
    updateSectionDropdown();
    const filtered = getFilteredAndSortedTasks();
    
    app.innerHTML = filtered.length ? 
      filtered.map(task => renderTask(task)).join('') : 
      '<div class="card" style="text-align:center;padding:40px"><div class="muted">–ù–µ—Ç –∑–∞–¥–∞—á –ø–æ —Ñ–∏–ª—å—Ç—Ä—É</div></div>';
    
    countContainer.innerHTML = `<div class="count-badge">üìä ${filtered.length}</div>`;
  }

  

function renderTask(task) {
  const isEditing = editingTaskId === task.id;
  const showAnswer = task.isAnswerVisible || allAnswersVisible; // –¢–æ–ª—å–∫–æ –¥–ª—è answerImage
  const showDrawingsSolutions = allDrawingsSolutionsVisible; // –û—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –¥–ª—è —á–µ—Ä—Ç–µ–∂–µ–π/—Ä–µ—à–µ–Ω–∏–π
  const sections = getAllSections();
  
  if (task.isSectionHeader) {
    return `
      <div class="task" data-id="${task.id}" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
        <div class="task-head" style="background: transparent; color: white;">
          <div class="title" style="font-size: 22px;">üìÅ ${escapeHtml(task.title)}</div>
        </div>
      </div>
    `;
  }
  
  // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —Å—Å—ã–ª–æ–∫ –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ –∏ –≤–∏–¥–µ–æ
  const solutionLinkHtml = task.solutionLink ? 
    `<a href="${escapeHtml(task.solutionLink)}" target="_blank" class="badge link">üîó –†–µ—à–µ–Ω–∏–µ</a>` : '';
  
  const videoLinkHtml = task.videoLink ? 
    `<a href="${escapeHtml(task.videoLink)}" target="_blank" class="badge link">üìπ –í–∏–¥–µ–æ</a>` : '';
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —á–µ—Ä—Ç–µ–∂–∞ –∏ —Ä–µ—à–µ–Ω–∏—è
  const hasDrawing = !!task.drawingImage;
  const hasSolution = !!task.solutionImage;
  
  return `
    <div class="task" data-id="${task.id}">
      <div class="task-head">
        <div>
          <div class="title">${escapeHtml(task.title || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)')}</div>
          <div class="badges">
            <span class="badge section">üìÇ ${escapeHtml(task.sectionName || '-')}</span>
            <span class="badge difficulty">üìä 
              <span style="color: ${task.difficulty === 'basic' ? '#059669' : task.difficulty === 'medium' ? '#d97706' : '#dc2626'}; font-weight: bold;">
                ${task.difficulty === 'basic' ? '–õ—ë–≥–∫–∞—è' : task.difficulty === 'medium' ? '–°—Ä–µ–¥–Ω—è—è' : '–°–ª–æ–∂–Ω–∞—è'}
              </span>
            </span>
            <span class="badge">${task.isSolved ? '‚úÖ —Ä–µ—à–µ–Ω–æ' : '‚ùå –Ω–µ —Ä–µ—à–µ–Ω–æ'}</span>
            <span class="badge">${task.isFavorite ? '‚≠ê –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' : '‚òÜ'}</span>
            ${solutionLinkHtml}
            ${videoLinkHtml}
          </div>
        </div>
        <div class="actions">
          <button data-act="toggleSolved">${task.isSolved ? '–°–Ω—è—Ç—å ‚úÖ' : '–í —Ä–µ—à—ë–Ω–Ω—ã–µ ‚úÖ'}</button>
          <button data-act="toggleFav">${task.isFavorite ? '–£–±—Ä–∞—Ç—å ‚≠ê' : '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚≠ê'}</button>
          <button data-act="edit" class="${isEditing ? '' : 'primary'}">${isEditing ? 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'}</button>
          <button data-act="clearImages">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
          <button data-act="delete" class="danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
      
      <div class="task-body">
        <div class="split">
          <div class="zone task-zone ${task.taskImage ? '' : 'empty'}" data-zone="taskImage" tabindex="0">
            <h4>üìã –£—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏</h4>
            ${task.taskImage ? `<img src="${task.taskImage}" alt="–£—Å–ª–æ–≤–∏–µ">` : ''}
            <div class="hint">Ctrl+V –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏</div>
          </div>
          
          <div class="zone answer-zone ${task.answerImage ? '' : 'empty'}" data-zone="answerImage" tabindex="0">
            <h4>üí° –û—Ç–≤–µ—Ç</h4>
            ${showAnswer && task.answerImage ? `<img src="${task.answerImage}" alt="–û—Ç–≤–µ—Ç">` : ''}
            ${!showAnswer ? '<div class="hint">–∫–ª–∏–∫–Ω–∏ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>' : ''}
            <div class="hint">Ctrl+V –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏</div>
          </div>
        </div>
        
        <!-- –ü–æ–∫–∞–∑–∞—Ç—å —á–µ—Ä—Ç–µ–∂–∏ –∏ —Ä–µ—à–µ–Ω–∏—è (–û–¢–î–ï–õ–¨–ù–û –æ—Ç –æ—Ç–≤–µ—Ç–æ–≤) -->
        ${(hasDrawing || hasSolution) && showDrawingsSolutions ? `
          <div class="drawings-solutions-section" style="margin-top: 20px; border-top: 2px dashed #e2e8f0; padding-top: 20px;">
            <h4 style="margin: 0 0 12px 0; font-size: 14px; color:#64748b; font-weight: 600;">üìê –ß–µ—Ä—Ç–µ–∂–∏ –∏ —Ä–µ—à–µ–Ω–∏—è:</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 16px;">
              ${hasDrawing && showDrawingsSolutions ? `
                <div style="flex: 1; min-width: 200px;">
                  <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">–ß–µ—Ä—Ç–µ–∂:</div>
                  <img src="${task.drawingImage}" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                </div>
              ` : ''}
              ${hasSolution && showDrawingsSolutions ? `
                <div style="flex: 1; min-width: 200px;">
                  <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">–†–µ—à–µ–Ω–∏–µ:</div>
                  <img src="${task.solutionImage}" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                </div>
              ` : ''}
            </div>
          </div>
        ` : ''}
        
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è —á–µ—Ä—Ç–µ–∂–∞ –∏ —Ä–µ—à–µ–Ω–∏—è -->
        <div class="image-buttons">
          <button class="image-btn ${hasDrawing ? 'has-image' : ''}" 
                  data-act="showDrawing" 
                  ${!hasDrawing ? 'disabled style="opacity:0.5;"' : ''}>
            üìê –ß–µ—Ä—Ç–µ–∂ ${hasDrawing ? '‚úì' : ''}
          </button>
          <button class="image-btn ${hasSolution ? 'has-image' : ''}" 
                  data-act="showSolution" 
                  ${!hasSolution ? 'disabled style="opacity:0.5;"' : ''}>
            üìù –†–µ—à–µ–Ω–∏–µ ${hasSolution ? '‚úì' : ''}
          </button>
          ${isEditing ? `
            <button class="image-btn" data-act="pasteDrawing" style="font-size:11px;">
              üìã –í—Å—Ç–∞–≤–∏—Ç—å —á–µ—Ä—Ç–µ–∂
            </button>
            <button class="image-btn" data-act="pasteSolution" style="font-size:11px;">
              üìã –í—Å—Ç–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ
            </button>
            <button class="image-btn" data-act="clearDrawingSolution" style="font-size:11px; background: #fef2f2; color: #dc2626; border-color: #fca5a5;">
              üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –æ–±–∞
            </button>
          ` : ''}
        </div>
        
        ${isEditing ? `
          <div class="card">
            <div class="meta-row">
              <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input data-field="title" value="${escapeHtml(task.title)}"></div>
              <div><label>–†–∞–∑–¥–µ–ª</label>
                <select data-field="sectionName" class="dropdown">
                  <option value="">‚ûï –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª</option>
                  ${sections.map(s => `<option value="${escapeHtml(s)}" ${task.sectionName === s ? 'selected' : ''}>${escapeHtml(s)}</option>`).join('')}
                </select>
              </div>
              <div><label>–°–µ–∫—Ü–∏—è</label>
                <select data-field="section" class="dropdown">
                  <option value="">‚ûï –Ω–æ–≤–∞—è —Å–µ–∫—Ü–∏—è</option>
                  ${sections.map(s => `<option value="${escapeHtml(s)}" ${task.section === s ? 'selected' : ''}>${escapeHtml(s)}</option>`).join('')}
                </select>
              </div>
              <div><label>–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                <select data-field="difficulty" class="dropdown">
                  <option value="basic" ${task.difficulty === 'basic' ? 'selected' : ''}>üü¢ –õ—ë–≥–∫–∞—è</option>
                  <option value="medium" ${task.difficulty === 'medium' ? 'selected' : ''}>üü° –°—Ä–µ–¥–Ω—è—è</option>
                  <option value="hard" ${task.difficulty === 'hard' ? 'selected' : ''}>üî¥ –°–ª–æ–∂–Ω–∞—è</option>
                </select>
              </div>
              <div><label>–†–µ—à–µ–Ω–∏–µ</label><input data-field="solutionLink" value="${escapeHtml(task.solutionLink)}" placeholder="https://..."></div>
              <div><label>–í–∏–¥–µ–æ</label><input data-field="videoLink" value="${escapeHtml(task.videoLink)}" placeholder="https://..."></div>
            </div>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

















  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      tasks = Array.isArray(data) ? data.map(normalizeTask) : [normalizeTask(data)];
      render();
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ JSON: ' + err.message);
    }
    e.target.value = '';
  });

  btnExport.addEventListener('click', () => {
  const jsonString = JSON.stringify(tasks.map(t => {
    const taskCopy = {...t};
    taskCopy.isAnswerVisible = false;
    return taskCopy;
  }), null, 2);
  
  // –ü—Ä–æ—Å–∏–º —Ç–æ–ª—å–∫–æ –∏–º—è –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
  let fileName = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ .json):', 'tasks');
  
  if (fileName === null) return; // –û—Ç–º–µ–Ω–∞
  
  fileName = fileName.trim();
  if (!fileName) fileName = 'tasks';
  
  // –£–¥–∞–ª—è–µ–º .json –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å
  fileName = fileName.replace(/\.json$/i, '');
  
  const finalFileName = fileName + '.json';
  
  // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
  const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = finalFileName;
  document.body.appendChild(a);
  a.click();
  
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
  }, 100);
});

btnAddSection.addEventListener('click', () => {
  const newSection = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞:');
  if (newSection && newSection.trim()) {
    const sectionName = newSection.trim();
    availableSections.add(sectionName);
    alert(`–†–∞–∑–¥–µ–ª "${sectionName}" –¥–æ–±–∞–≤–ª–µ–Ω. –¢–µ–ø–µ—Ä—å –µ–≥–æ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏.`);
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
    updateSectionDropdown();
  }
});

  btnToggleAnswers.addEventListener('click', () => {
    allAnswersVisible = !allAnswersVisible;
    btnToggleAnswers.textContent = allAnswersVisible ? '–°–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç—ã' : '–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç—ã';
    btnToggleAnswers.classList.toggle('active');
    render();
  });

  btnAdd.addEventListener('click', () => {
    resetFilters();
    const newTask = normalizeTask({ title: '', sectionName: '', difficulty: 'basic' });
    tasks.unshift(newTask);
    editingTaskId = newTask.id;
    render();
    setTimeout(() => {
      const titleInput = app.querySelector('input[data-field="title"]');
      titleInput?.focus();
    }, 200);
  });

  difficultyBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      difficultyBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      render();
    });
  });

  [q, fSection, fSolved, fFav].forEach(el => {
    el.addEventListener('input', render);
    el.addEventListener('change', render);
  });

  sortTitleBtn.addEventListener('click', () => {
    sortByTitle = !sortByTitle;
    sortTitleBtn.textContent = sortByTitle ? '‚Üì –Ω–∞–∑–≤–∞–Ω–∏–µ' : '‚Üë –Ω–∞–∑–≤–∞–Ω–∏–µ';
    render();
  });

app.addEventListener('click', async (e) => {
  const btn = e.target.closest('button[data-act]');
  if (!btn) return;
  
  const taskEl = btn.closest('.task');
  const taskId = Number(taskEl.dataset.id);
  const task = tasks.find(t => t.id === taskId);
  
  if (!task) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–¥–∞—á–∏
  
  const act = btn.dataset.act;
  
  if (act === 'toggleSolved') {
    task.isSolved = !task.isSolved;
    render();
  } else if (act === 'toggleFav') {
    task.isFavorite = !task.isFavorite;
    render();
  } else if (act === 'edit') {
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if (editingTaskId === task.id) {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      editingTaskId = null;
    } else {
      // –í—Ö–æ–¥–∏–º –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏
      editingTaskId = task.id;
    }
    render();
  } else if (act === 'clearImages') { 
    task.taskImage = ''; 
    task.answerImage = ''; 
    task.drawingImage = '';
    task.solutionImage = '';
    render();
  } else if (act === 'delete') {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) {
      tasks = tasks.filter(t => t.id !== taskId);
      // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—É—é –∑–∞–¥–∞—á—É, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º editingTaskId
      if (editingTaskId === taskId) {
        editingTaskId = null;
      }
      render();
    }
  } else if (act === 'showDrawing' && task.drawingImage) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ—Ä—Ç–µ–∂ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    showModal(task.drawingImage, `–ß–µ—Ä—Ç–µ–∂: ${task.title}`);
  } else if (act === 'showSolution' && task.solutionImage) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ—à–µ–Ω–∏–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    showModal(task.solutionImage, `–†–µ—à–µ–Ω–∏–µ: ${task.title}`);
  } else if (act === 'pasteDrawing' && editingTaskId === taskId) {
    // –í—Å—Ç–∞–≤–∫–∞ —á–µ—Ä—Ç–µ–∂–∞ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞
    const items = await navigator.clipboard.read();
    for (const item of items) {
      for (const type of item.types) {
        if (type.startsWith('image/')) {
          const blob = await item.getType(type);
          const dataUrl = await toDataUrlFromFile(blob);
          task.drawingImage = dataUrl;
          render();
          return;
        }
      }
    }
    alert('–í –±—É—Ñ–µ—Ä–µ –æ–±–º–µ–Ω–∞ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
  } else if (act === 'pasteSolution' && editingTaskId === taskId) {
    // –í—Å—Ç–∞–≤–∫–∞ —Ä–µ—à–µ–Ω–∏—è –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞
    const items = await navigator.clipboard.read();
    for (const item of items) {
      for (const type of item.types) {
        if (type.startsWith('image/')) {
          const blob = await item.getType(type);
          const dataUrl = await toDataUrlFromFile(blob);
          task.solutionImage = dataUrl;
          render();
          return;
        }
      }
    }
    alert('–í –±—É—Ñ–µ—Ä–µ –æ–±–º–µ–Ω–∞ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
  } else if (act === 'clearDrawingSolution' && editingTaskId === taskId) {
    // –û—á–∏—Å—Ç–∫–∞ —á–µ—Ä—Ç–µ–∂–∞ –∏ —Ä–µ—à–µ–Ω–∏—è
    task.drawingImage = '';
    task.solutionImage = '';
    render();
  }
});

  app.addEventListener('input', (e) => {
  const input = e.target.closest('[data-field]');
  if (!input || !editingTaskId) return;
  
  const taskEl = app.querySelector(`.task[data-id="${editingTaskId}"]`);
  const taskId = Number(taskEl.dataset.id);
  const task = tasks.find(t => t.id === taskId);
  task[input.dataset.field] = input.value;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—É—é –∑–∞–¥–∞—á—É, –∞ –Ω–µ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
  if (taskEl) {
    const titleEl = taskEl.querySelector('.title');
    if (titleEl && input.dataset.field === 'title') {
      titleEl.textContent = task.title || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)';
    }
  }
});

  app.addEventListener('change', (e) => {
    const select = e.target.closest('select[data-field]');
    if (!select || !editingTaskId) return;
    
    const taskEl = app.querySelector(`.task[data-id="${editingTaskId}"]`);
    const taskId = Number(taskEl.dataset.id);
    const task = tasks.find(t => t.id === taskId);
    
    if (select.dataset.field === 'sectionName' && select.value === '') {
      const newSection = prompt('–ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª:');
      if (newSection) {
        task.sectionName = newSection.trim();
        select.value = newSection.trim();
      }
    } else if (select.dataset.field === 'section' && select.value === '') {
      const newSection = prompt('–ù–æ–≤–∞—è —Å–µ–∫—Ü–∏—è:');
      if (newSection) {
        task.section = newSection.trim();
        select.value = newSection.trim();
      }
    } else {
      task[select.dataset.field] = select.value;
    }
    render();
  });

  document.addEventListener('paste', async (e) => {
    if (!editingTaskId) return;
    
    const zone = e.target.closest('.zone[data-zone]');
    if (!zone) return;
    
    const items = Array.from(e.clipboardData?.items || []);
    const imageItem = items.find(item => item.type?.startsWith('image/'));
    
    if (imageItem) {
      e.preventDefault();
      const file = imageItem.getAsFile();
      if (file) {
        const dataUrl = await toDataUrlFromFile(file);
        const taskEl = zone.closest('.task');
        const taskId = Number(taskEl.dataset.id);
        const task = tasks.find(t => t.id === taskId);
        
        if (zone.dataset.zone === 'answerImage') {
          task.answerImage = dataUrl;
          task.isAnswerVisible = true;
        } else if (zone.dataset.zone === 'taskImage') {
          task.taskImage = dataUrl;
        }
        render();
      }
    }
  });

  app.addEventListener('click', (e) => {
    const zone = e.target.closest('.zone[data-zone="answerImage"]');
    if (zone && !editingTaskId) {
      const taskEl = zone.closest('.task');
      const taskId = Number(taskEl.dataset.id);
      const task = tasks.find(t => t.id === taskId);
      task.isAnswerVisible = !task.isAnswerVisible;
      render();
    }
  });






  

function printTasks(showAnswers) {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤–∏–¥–∏–º–æ—Å—Ç—å
  const originalVisibility = tasks.map(t => t.isAnswerVisible);
  
  // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  if (showAnswers) {
    tasks.forEach(t => t.isAnswerVisible = true);
  }
  
  const filtered = getFilteredAndSortedTasks();
  printRoot.innerHTML = filtered.map(task => {
    if (task.isSectionHeader) {
      return `<h2 style="page-break-after: avoid;">üìÅ ${escapeHtml(task.title)}</h2>`;
    }
    
    const answerHtml = showAnswers && task.answerImage ? 
      `<div style="margin-top: 20px; text-align: left;"> <!-- –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é -->
        <div style="font-weight: bold; margin-bottom: 10px;">–û—Ç–≤–µ—Ç:</div>
        <img src="${task.answerImage}" style="max-width: 50%; max-height: 200px; transform: scale(0.5); transform-origin: left top;"> <!-- –í 2 —Ä–∞–∑–∞ –º–µ–Ω—å—à–µ -->
      </div>` : '';
    
    return `
      <div class="task" style="margin-bottom: 40px; page-break-inside: avoid;">
        <div class="title">${escapeHtml(task.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
        <div class="badges" style="margin-bottom: 10px;">
          <span style="background: #dbeafe; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
            ${escapeHtml(task.sectionName || '–ë–µ–∑ —Ä–∞–∑–¥–µ–ª–∞')}
          </span>
        </div>
        <div class="zone" style="margin-bottom: 25px;">
          ${task.taskImage ? `<img src="${task.taskImage}">` : '<div style="padding: 20px; background: #f0f0f0;">–ù–µ—Ç —É—Å–ª–æ–≤–∏—è</div>'}
        </div>
        ${answerHtml}
      </div>
    `;
  }).join('');
  
  window.print();
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
  tasks.forEach((t, i) => {
    t.isAnswerVisible = originalVisibility[i];
  });
  
  setTimeout(render, 100);
}

  btnPrintNoAnswer.addEventListener('click', () => printTasks(false));
  btnPrintWithAnswer.addEventListener('click', () => printTasks(true));

  tasks = [normalizeTask({
    id: 1768892475986,
    title: "18.2",
    sectionName: "–ê–ù–ê–õ–ò–¢–ò–ö–ê –ü–†–û–ß–ï–ï",
    section: "4",
    difficulty: "basic"
  })];

  render();
})();
</script>


</body></html>